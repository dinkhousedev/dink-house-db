_format_version: "2.1"

services:
  - name: auth-v1
    url: http://auth:9999/
    routes:
      - name: auth-v1-all
        strip_path: true
        paths:
          - /auth/v1/

  - name: rest-v1
    url: http://rest:3000/
    routes:
      - name: rest-v1-all
        strip_path: true
        paths:
          - /rest/v1/

  - name: realtime-v1
    url: http://realtime:4000/socket
    routes:
      - name: realtime-v1-all
        strip_path: true
        paths:
          - /realtime/v1/

  - name: realtime-v1-ws
    url: http://realtime:4000/socket
    routes:
      - name: realtime-v1-ws
        strip_path: true
        paths:
          - /realtime/v1/websocket
        protocols:
          - http
          - https

  - name: storage-v1
    url: http://storage:5000/
    routes:
      - name: storage-v1-all
        strip_path: true
        paths:
          - /storage/v1/

  - name: pg-meta
    url: http://pg-meta:8080/
    routes:
      - name: pg-meta-all
        strip_path: true
        paths:
          - /pg/

  - name: functions-v1
    url: http://functions:9000/
    routes:
      - name: functions-v1-all
        strip_path: true
        paths:
          - /functions/v1/

consumers:
  - username: anon
    keyauth_credentials:
      - key: ${ANON_KEY}

  - username: service_role
    keyauth_credentials:
      - key: ${SERVICE_KEY}

plugins:
  - name: cors
    config:
      origins:
        - http://localhost:3000
        - http://localhost:3001
        - http://localhost:9000
        - ${API_EXTERNAL_URL}
      methods:
        - GET
        - HEAD
        - PUT
        - PATCH
        - POST
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Authorization
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - X-Auth-Token
        - X-CSRF-Token
        - X-Requested-With
        - apikey
        - x-client-info
      exposed_headers:
        - X-Auth-Token
        - Authorization
        - Content-Range
        - Content-Encoding
        - Content-Length
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      credentials: true
      max_age: 86400

  - name: key-auth
    config:
      key_names:
        - apikey
        - Apikey
      key_in_header: true
      key_in_query: false
      key_in_body: false
      hide_credentials: true
      run_on_preflight: false

  - name: rate-limiting
    config:
      second: 100
      minute: 1000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      redis_database: 0
      redis_host: redis
      redis_port: 6379

  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes

  - name: request-transformer
    config:
      add:
        headers:
          - "X-Client-Info:dink-house-api"

  - name: response-transformer
    config:
      add:
        headers:
          - "X-API-Version:1.0.0"

consumers:
  - username: anon
    keyauth_credentials:
      - key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNzU4ODM4OTY0LCJleHAiOjIwNzQxOTg5NjR9.CKoGIoMTUDl6x8kmtaIuAMjGBvlV_7KyJhC-DSb-akI

  - username: service_role
    keyauth_credentials:
      - key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoic2VydmljZV9yb2xlIiwiaXNzIjoic3VwYWJhc2UiLCJpYXQiOjE3NTg4Mzg5NjQsImV4cCI6MjA3NDE5ODk2NH0.8H_56dyR3AUPJi44Jgf5O7iuKg12FHmrkZWfLU6zoc0